<!DOCTYPE HTML>
<html>
	<head>
		<title>rxmysondygo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
		<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.css" type="text/css" media="all" /> 
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
			integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
			crossorigin=""/>
		<script src='https://code.jquery.com/jquery-3.6.3.min.js'></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/timeago.js/2.0.2/timeago.min.js"></script>
		<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
			integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
			crossorigin=""></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js" type="text/javascript"></script>
		<style>
			html, body, table, #map {margin:0;padding:0}
			html { font-family: Arial, Helvetica, sans-serif; }
			#map { height: 90vh; clear:both }
			#configura, #log { float:right }
			table { height:10vh; border-collapse: collapse; width:80%;float:left }
			table, th, td { border: 1px solid }
			table thead {background-color:gray;color:white}
			table tbody tr td {text-align:center}
			table tbody tr td:nth-child(3) {text-align:right}
			table tbody tr td:nth-child(5) {text-align:right}
			table tbody tr td:nth-child(6) {text-align:right}
			table tbody tr td:nth-child(7) {text-align:right}
			table tbody tr td:nth-child(8) {text-align:right}
			fieldset {
				margin: 10px;
				padding: 0 10px 10px;
				border: 1px solid #666;
				border-radius: 8px;
				padding-top: 10px;
			}
			.ui-dialog { z-index: 1000 !important ;}
		</style>
		<script>
//TODO: cancelazione sonde dopo 6 ore
//TODO: log per sonda
"strict"
var map;
var last='';
var n=0;
var colors=[
	'blue',
	'cyan',
	'green',
	'purple',
	'red',
	'yellow'
];
var data=[];

function updateTable() {
	for (id in data) {
		var row=$(`#${id}`);
		if (row.length==0) {
			row=$('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>');
			$('table tbody').append(row);
		}
		row.attr('id',id);
		var cells=row.find('td');
		var i=data[id].frames.length-1;
		$(cells[0]).html(timeago().format(data[id].frames[i].datetime,'IT'));
		$(cells[1]).html(data[id].type);
		$(cells[2]).html(data[id].freq);
		$(cells[3]).html(id);
		$(cells[4]).html(data[id].frames[i].lat);
		$(cells[5]).html(data[id].frames[i].lon);
		$(cells[6]).html(data[id].frames[i].alt);
		$(cells[7]).html(data[id].frames[i].rssi);
	}
}

function getData() {
	var url=new URL(window.location.href);
	
	url.pathname=url.pathname.replace(/\/[^\/]*$/,'/data');
	$.getJSON({
		url:url,
		data:{from:last}
	}).done(function(newData) {
		console.log(newData);
		for (id in newData) {
			if (data[id]==null) {
				data[id]=newData[id];
				var color=colors[n++];
				var d=newData[id].frames;
				points=d.map(x=>[x.lat,x.lon]);
				data[id].path=L.polyline(points, {color: color}).addTo(map);
				if (points.length>0) {
					var icon=L.icon({
						iconUrl:`balloon-${color}.png`,
						iconSize:[48,92],
						iconAnchor: [24,92],
						popupAnchor: [24,0]
					});
					data[id].marker=L.marker(points[points.length-1],{icon:icon})
						.bindPopup(id)
						.addTo(map);
					last=newData[id].frames[points.length-1].datetime;
					updateTable();
				}
			}
			else {
				var frames=newData[id].frames;
				for (i in frames)
					data[id].path.addLatLng([frames[i].lat,frames[i].lon])
//~ 				data[id].path.redraw();
				var i=frames.length-1;
				if (i>=0) {
					data[id].frames.push(...newData[id].frames);
					var position=L.latLng(frames[i].lat,frames[i].lon);
					console.log('position: ',position,frames[i]);
					data[id].marker.setLatLng(position);
					last=newData[id].frames[i].datetime;
					updateTable();
				}
			}
		}
	}).fail(function(jqxhr, textStatus, error ) {
		console.log(textStatus,error);
	}).always(function() {
		setTimeout(getData,3000);
	});
}

$(document).ready(function() {
	timeago.register('IT', (number, index, totalSec)=> {
		return [
			[ "adesso", "ora" ],
			[ "meno di un minuto fa", "tra meno di un minuto" ],
			[ "1 minuto fa", "tra 1 minuto" ],
			[ "%s minuti fa", "tra %s minuti" ],
			[ "un'ora fa","tra un'ora" ],
			[ "%s ore fa", "tra %s ore" ],
			[ "ieri","domani" ],
			[ "%s giorni fa","tra %s giorni" ],
			["un mese fa","tra un mese" ],
			[ "%s mesi fa", "tra %s mesi" ],
			[ "circa un anno fa", "tra un anno circa" ],
			[ "%s anni fa", "tra %s anni" ]
		][index];
	});
	timeago().setLocale('IT');
	$('#configura').button({ icon: "ui-icon-gear" });
	$('#log').button({ icon: "ui-icon-comment" });
	$( "#dialog" ).dialog({
		autoOpen:false,
		modal: true,
		minHeight: 300,
		minWidth: 400,
		close: function() {
			$('#dialog fieldset:not(:first-child)').remove();
		},
		buttons: [{
			id: "btn-ok",
			text: "OK",
			click: function () {
				var cfg={};
				$('fieldset').each(function(i, element) {
					element=$(element);
					cfg[element.find('legend').html()]= {
						type: element.find('#tipo').val(),
						freq: parseFloat(element.find('#freq').val())
					};
				});
				console.log(cfg);
				var url=new URL(window.location.href);
				url.pathname=url.pathname.replace(/\/[^\/]*$/,'/cfg');
				$.post(url,JSON.stringify(cfg));
				$( "#dialog" ).dialog("close");
			}
		}]});
	$('#log').on( "click", function(event) {
		alert('Da fare...');
	});
	$('#configura').on( "click", function(event) {
		var url=new URL(window.location.href);
		
		url.pathname=url.pathname.replace(/\/[^\/]*$/,'/cfg');
		$.getJSON({ url:url }).done(function(cfg) {
			var fieldset=null
			//cfg['x']={type:'M20',freq:405};
			for (i in cfg) {
				fieldset= fieldset==null ? $('fieldset') : fieldset.clone().appendTo('#dialog');
				fieldset.find('legend').html(i);
				fieldset.find('#tipo').val(cfg[i].type);
				fieldset.find('#freq').val(cfg[i].freq);
			}
			$('#dialog').dialog("open");
		}).fail(function() {
			alert('errore lettura configurazione server');
		});
	});
	map = L.map('map').setView([44.4, 7.6], 11);
	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);

	getData();
});
		</script>
	</head>
	<body>
		<table>
			<thead>
				<tr>
					<th>Tempo</th>
					<th>Tipo</th>
					<th>Freq</th>
					<th>ID</th>
					<th>Lat</th>
					<th>Lon</th>
					<th>Alt</th>
					<th>RSSI</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<button id='configura'>configura</button>
		<button id='log'>log</button>
		<div id="dialog" title="Impostazioni">
			<fieldset id='ttgo'>
				<legend>pippo</legend> 
				<label>Tipo: </label><select id='tipo'>
					<option value='RS41'>RS41</option>
					<option value='M20'>M20</option>
					<option value='M10'>M10</option>
					<option value='PIL'>PIL</option>
					<option value='DFM'>DFM</option>
				</select>
				&nbsp;&nbsp;
				<label></label>Frequenza: <input id='freq' type='number' value='403.700' min='400.000' max='406.000' step='0.1'/>
			</fieldset>
		</div>
		<div id="map"></div>
	</body>
</html>
